---
// Detect language from path like other components
const currentPath = Astro.url.pathname;
const match = currentPath.match(/^\/(en|es)/);
const currentLang = match ? match[1] : 'en';
---

<div
  class="lang-switch bg-secondary p-1.5 flex justify-center items-center gap-4 rounded-full relative"
  data-current-lang={currentLang}
>
  <span class="switch-thumb" aria-hidden="true"></span>
  <button
    data-lang="en"
    aria-pressed={currentLang === 'en' ? 'true' : 'false'}
    class={`rounded-full w-8 h-8 md:w-9 md:h-9 flex justify-center items-center cursor-pointer ${currentLang === 'en' ? 'bg-white' : ''}`}
  >
    <p
      class={`${currentLang === 'en' ? 'text-secondary' : 'text-white'} font-semibold`}
    >
      EN
    </p>
  </button>
  <button
    data-lang="es"
    aria-pressed={currentLang === 'es' ? 'true' : 'false'}
    class={`rounded-full w-8 h-8 md:w-9 md:h-9 flex justify-center items-center cursor-pointer ${currentLang === 'es' ? 'bg-white' : ''}`}
  >
    <p
      class={`${currentLang === 'es' ? 'text-secondary' : 'text-white'} font-semibold`}
    >
      ES
    </p>
  </button>
</div>
<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Subtle shadow and slight rounding for flags to improve contrast on colored backgrounds */
  .flag-shadow {
    box-shadow:
      0 6px 14px rgba(0, 0, 0, 0.28),
      0 0 0 2px rgba(255, 255, 255, 0.06);
    border-radius: 6px;
    display: inline-block;
  }

  .lang-switch {
    position: relative;
  }
  .lang-switch .switch-thumb {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    border-radius: 9999px;
    background: white;
    transition:
      left 0.22s cubic-bezier(0.22, 0.9, 0.36, 1),
      width 0.22s cubic-bezier(0.22, 0.9, 0.36, 1);
    z-index: 5;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
  }
  /* Ensure buttons sit above the thumb for text visibility */
  .lang-switch button {
    position: relative;
    z-index: 10;
  }
</style>

<script is:inline>
  // Animated switch behaviour: position thumb on current language and animate before navigation
  (function () {
    const container = document.querySelector('.lang-switch');
    if (!container) return;
    const thumb = container.querySelector('.switch-thumb');
    const buttons = container.querySelectorAll('button[data-lang]');
    const current = container.getAttribute('data-current-lang');

    function positionThumb(lang, instant) {
      const btn = container.querySelector(`button[data-lang="${lang}"]`);
      if (!btn) return;
      const left = btn.offsetLeft;
      const width = btn.offsetWidth;
      thumb.style.width = width + 'px';
      if (instant) {
        thumb.style.transition = 'none';
      } else {
        thumb.style.transition = '';
      }
      // set left after clearing transition if needed
      requestAnimationFrame(() => {
        thumb.style.left = left + 'px';
      });
    }

    // initial position
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () =>
        positionThumb(current, true)
      );
    } else positionThumb(current, true);

    buttons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const lang = btn.getAttribute('data-lang');
        if (!lang) return;
        if (lang === current) {
          return;
        }
        sessionStorage.setItem('langScroll', window.scrollY);
        positionThumb(lang, false);
        const newPath = window.location.pathname.replace(
          /^\/(es|en)/,
          `/${lang}`
        );
        // wait a bit to let animation play
        setTimeout(() => {
          window.location.href = newPath;
        }, 220);
      });

      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          btn.click();
        }
      });
    });
  })();
</script>

<script is:inline>
  // Restauración de posición con prevención de parpadeo
  document.addEventListener('DOMContentLoaded', () => {
    const savedPosition = sessionStorage.getItem('langScroll');

    if (savedPosition !== null) {
      // Restaurar posición antes de mostrar contenido
      window.scrollTo({
        top: parseInt(savedPosition, 10),
        behavior: 'instant',
      });
      sessionStorage.removeItem('langScroll');
    }

    // Mostrar contenido después de restaurar posición
    document.body.classList.add('visible');
  });
</script>
