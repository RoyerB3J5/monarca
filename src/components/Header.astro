---
import Button from './Button.astro';
import { Icon } from 'astro-icon/components';
import ChangeLanguage from './ChangeLanguage.astro';

type Translations = typeof import('../i18n/en').default;
type HeaderContent = Translations['header'];
interface Props {
  content?: HeaderContent;
}
const { content } = Astro.props as Props;

// Obtener la ruta actual y normalizar el path sin prefijo de idioma
const currentPath = Astro.url.pathname;
// Normalizar: remover idioma y trailing slash
const normalized =
  currentPath.replace(/^\/(en|es)/, '').replace(/\/$/, '') || '/';
// Detectar el idioma actual ('en' o 'es')
const match = currentPath.match(/^\/(en|es)/);
const lang = match ? match[1] : 'en';
---

<header
  class={`fixed left-0 right-0 z-50 w-full flex flex-col justify-center items-center transition-top duration-300 ease-in-out border-0 top-3 lg:top-0 `}
  id="site-header"
>
  <div
    class={`w-[calc(100%-40px)] xl:w-full sm:max-w-7xl pt-[9px] md:py-0 lg:min-h-[90px] flex justify-between items-center px-[15px] md:px-4  relative bg-primary lg:top-5 xl:px-[51px] pb-[9px] md:pb-1 rounded-[20px] mx-auto shadow-lg sm:shadow-none`}
  >
    <!-- Menú desktop (lg y arriba) -->
    <div
      class="hidden lg:relative lg:flex items-center bg-transparent text-white flex-row h-auto w-auto z-10 py-0 gap-0 transform translate-x-0 transition-transform duration-300 ease-out"
    >
      <nav
        class="relative flex items-center flex-row justify-center w-auto gap-7"
      >
        {
          content?.nav.map((item, index) => {
            const itemPathWithoutHash = item.href.split('#')[0];
            const isActive =
              normalized === itemPathWithoutHash ||
              (index === 0 && normalized.startsWith('/services'));
            const isServices = index === 0;
            return (
              <div
                class={`flex flex-row items-center justify-center  hover:text-blue-light w-auto py-0 text-center ${isServices ? 'relative dropdown-parent' : ''} ${isActive ? 'bg-transparent ' : ''}`}
                id={`services-${index}`}
              >
                <a
                  href={`/${lang}${item.href}`}
                  class=" relative transition-colors duration-300 flex justify-center items-center gap-[7px]"
                >
                  {item.icon && (
                    <img
                      src={`/images/${item.icon}.png`}
                      alt={`${item.label} icon`}
                      class="w-5 h-5"
                    />
                  )}

                  <p
                    class="text-[20px] font-normal leading-[120%] hover:text-secondary"
                    set:html={item.label}
                  />
                  <span
                    class={`absolute -bottom-2 left-0 h-0.5 bg-secondary group-hover:bg-white transition-all duration-300 ease-out  ${isActive ? 'w-full' : 'w-0 group-hover:w-full group-hover:bg-white'}`}
                  />
                </a>
                {isServices && (
                  <div class="dropdown-menu absolute top-[25px] left-0 mt-0 w-[200px] flex-col items-center bg-secondary z-40 hidden group-hover:flex opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-all duration-200 ease-out -translate-x-[25%] shadow-lg rounded-[10px] overflow-hidden">
                    {content.services.map((sub) => (
                      <div class="text-[18px] font-medium text-primary-dark py-2 hover:bg-primary-dark hover:text-white transition-colors duration-200 ease-in-out cursor-pointer px-6 w-full text-center">
                        <a
                          href={`/${lang}/services/${sub.href}`}
                          class="block w-full h-full"
                        >
                          {sub.label}
                        </a>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })
        }
      </nav>
    </div>
    <a
      href={`/${lang}`}
      aria-label="Ir a la página principal"
      title="Inicio Monarca - Mobile Pet Grooming"
    >
      <img
        src="/images/logo-shapehub.webp"
        alt="Logo de Monarca - Mobile Pet Grooming"
        width="1280"
        height="810"
        class="cursor-pointer w-[75px] md:w-[130px] h-auto"
      />
    </a>
    <div class="flex justify-center items-center gap-3">
      <Button
        text={content?.buttons[0].label}
        textClass="text-[13px] sm:text-[16px] text-white"
        href={`/${lang}/${content?.buttons[0].href}`}
        extraBtnClass={` border border-white bg-primary hidden lg:flex `}
        iconName={content?.buttons[0].icon}
        iconClass="text-primary"
      />
      <Button
        text={content?.buttons[1].label}
        href={content?.buttons[1].href}
        extraBtnClass={`border border-transparent bg-secondary hidden lg:flex`}
        iconName={content?.buttons[1].icon}
        iconClass="text-secondary"
      />
      <ChangeLanguage />
      <div class="flex lg:hidden justify-center items-center gap-7">
        <button
          type="button"
          aria-label="Abrir menú de navegación"
          title="Abrir menú"
          class="flex items-center justify-center"
          id="hamburger-btn"
        >
          <Icon name={'hamburger'} class={'w-6 h-6'} aria-hidden="true" />
          <span class="sr-only">Abrir menú de navegación</span>
        </button>
      </div>
    </div>
    <!-- Botones para móvil -->
  </div>
</header>

<!-- Menú móvil independiente (lg para abajo) -->
<div
  class="fixed top-0 right-0 bottom-0 lg:hidden flex items-center bg-primary text-white flex-col justify-center h-screen w-[90%] z-60 py-6 gap-12 transform translate-x-full transition-transform duration-300 ease-out"
  id="mobile-menu"
>
  <img
    src="/images/equis.svg"
    alt="Cerrar menú"
    width="24"
    height="24"
    class="block absolute top-6 right-6 cursor-pointer z-20"
    id="close-btn"
    aria-label="Cerrar menú de navegación"
    title="Cerrar menú"
    role="button"
    tabindex="0"
  />
  <a
    href="/"
    aria-label="Ir a la página principal"
    title="Inicio Monarca - Mobile Pet Grooming"
  >
    <img
      src="/images/logo-shapehub.webp"
      alt="Logo de Monarca - Mobile Pet Grooming"
      width="1280"
      height="810"
      class="cursor-pointer w-[190px] h-auto"
    />
  </a>
  <nav class="relative flex items-center flex-col justify-center w-full gap-4">
    {
      content?.nav.map((item, index) => {
        const itemPathWithoutHash = item.href.split('#')[0];
        const isActive =
          normalized === itemPathWithoutHash ||
          (index === 0 && normalized.startsWith('/services'));
        const isServices = index === 0;
        return (
          <div
            class={`flex flex-col items-center justify-center gap-3.5 px-0 hover:text-white w-full py-5 text-center ${isServices ? 'relative' : ''} ${isActive ? 'bg-[#BFDAF1] text-primary-dark uppercase' : ''}`}
            id={`mobile-services-${index}`}
          >
            <a
              href={`/${lang}${item.href}`}
              class="relative transition-colors duration-300 flex justify-center items-center gap-[7px]"
            >
              {item.icon && (
                <img
                  src={`/images/${item.icon}.png`}
                  alt={`${item.label} icon`}
                  class="w-6 h-6"
                />
              )}

              <p
                class="text-[18px] font-medium leading-[120%] hover:text-secondary"
                set:html={item.label}
              />
            </a>
            {isServices && (
              <div
                class="flex-col justify-center items-center w-full bg-secondary divide-y divide-primary-dark hidden absolute z-10 top-0 translate-y-[50px]"
                id="sub-menu-services"
              >
                {content.services.map((sub) => (
                  <a
                    href={`/${lang}/services/${sub.href}`}
                    class="text-[16px] font-medium text-primary-dark py-4 transition-colors duration-300 ease-in-out cursor-pointer px-6 w-full text-center"
                  >
                    {sub.label}
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })
    }
  </nav>

  <div class="flex flex-col justify-center items-center gap-5">
    <Button
      text={content?.buttons[0].label}
      textClass="text-[13px] sm:text-[16px] text-white"
      href={`/${lang}/${content?.buttons[0].href}`}
      extraBtnClass={` border border-white bg-primary `}
      iconName={content?.buttons[0].icon}
      iconClass="text-primary"
    />
    <Button
      text={content?.buttons[1].label}
      href={content?.buttons[1].href}
      extraBtnClass={`border border-secondary bg-secondary w-full`}
      iconName={content?.buttons[1].icon}
      iconClass="text-secondary"
    />
  </div>

  <style>
    /* Mejorar el comportamiento del dropdown */
    .dropdown-parent:hover .dropdown-menu {
      display: flex !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Crear un puente invisible entre el botón y el dropdown */
    .dropdown-parent::after {
      content: '';
      position: absolute;
      top: 100%;
      left: -10px;
      right: -10px;
      height: 4px;
      background: transparent;
      z-index: 39;
      pointer-events: auto;
    }

    /* Clase para texto solo visible para lectores de pantalla */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Asegurar que el dropdown se mantenga visible cuando se hace hover */
    .dropdown-menu:hover {
      display: flex !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Hacer que el dropdown mantenga el hover del padre */
    .dropdown-menu {
      margin-top: 0px;
    }

    /* Deshabilitar dropdown y puente en tamaños menores a lg */
    @media (max-width: 1023px) {
      .dropdown-parent::after {
        display: none;
      }

      .dropdown-parent:hover .dropdown-menu {
        display: none !important;
      }

      .dropdown-menu {
        display: none !important;
      }
    }
  </style>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('mobile-menu');
      const openBtn = document.getElementById('hamburger-btn');
      const closeBtn = document.getElementById('close-btn');
      const servicesDiv = document.getElementById('services-0'); // Desktop services (services is index 0)
      const mobileServicesDiv = document.getElementById('mobile-services-0'); // Mobile services (services is index 0)
      const subMenuServices = document.getElementById('sub-menu-services');
      const body = document.body;

      const isMobile = () => window.innerWidth < 1024;

      function openMenu() {
        if (isMobile()) {
          menu.classList.replace('translate-x-full', 'translate-x-0');
          body.classList.add('overflow-hidden');
        }
      }

      function closeMenu() {
        if (isMobile()) {
          menu.classList.replace('translate-x-0', 'translate-x-full');
          body.classList.remove('overflow-hidden');
        }
      }

      function toggleSubMenu(event) {
        // Solo en móvil prestamos atención al toggle
        if (!isMobile()) return;

        // Seguridad: si no existe el subMenuServices, no hacemos nada
        if (!subMenuServices) return;

        const isSubMenuOpen = !subMenuServices.classList.contains('hidden');

        // Si el submenu está cerrado, prevenimos la navegación y lo abrimos
        if (!isSubMenuOpen) {
          event.preventDefault();
          subMenuServices.classList.remove('hidden');
          subMenuServices.classList.add('flex');
        }
        // Si el submenu está abierto y se presiona de nuevo, cerramos el submenu
        // y evitamos la navegación para que el click solo actúe como toggle
        else {
          event.preventDefault();
          subMenuServices.classList.add('hidden');
          subMenuServices.classList.remove('flex');
        }
      }

      openBtn.addEventListener('click', openMenu);
      closeBtn.addEventListener('click', closeMenu);

      // Agregar event listener al div padre para que al pulsar el div (no solo el <a>) se active el toggle
      if (servicesDiv) {
        servicesDiv.addEventListener('click', (e) => {
          // Solo actuamos en móvil
          if (!isMobile()) return;
          // Ignorar clicks que vayan dirigidos al propio sub-menu (navegación de items)
          if (e.target.closest('#sub-menu-services')) return;
          toggleSubMenu(e);
        });
      }

      if (mobileServicesDiv) {
        mobileServicesDiv.addEventListener('click', (e) => {
          if (!isMobile()) return;
          if (e.target.closest('#sub-menu-services')) return;
          toggleSubMenu(e);
        });
      }

      // Asegurar estado inicial según tamaño
      if (isMobile()) {
        menu.classList.add('translate-x-full');
        menu.classList.remove('translate-x-0');
        body.classList.remove('overflow-hidden');
        if (subMenuServices) {
          subMenuServices.classList.add('hidden');
          subMenuServices.classList.remove('flex');
        }
      } else {
        menu.classList.add('translate-x-0');
        menu.classList.remove('translate-x-full');
        body.classList.remove('overflow-hidden');
      }

      window.addEventListener('resize', () => {
        if (!isMobile()) {
          menu.classList.add('translate-x-0');
          menu.classList.remove('translate-x-full');
          body.classList.remove('overflow-hidden');
          // Ocultar submenu en desktop
          if (subMenuServices) {
            subMenuServices.classList.add('hidden');
            subMenuServices.classList.remove('flex');
          }
        } else {
          // Asegura que el menú esté oculto al volver a móvil
          menu.classList.add('translate-x-full');
          menu.classList.remove('translate-x-0');
          body.classList.remove('overflow-hidden');
          if (subMenuServices) {
            subMenuServices.classList.add('hidden');
            subMenuServices.classList.remove('flex');
          }
        }
      });
      const header = document.getElementById('site-header');
      let lastScroll = window.pageYOffset;

      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;

        if (currentScroll > lastScroll && currentScroll > 100) {
          // Scroll hacia abajo: escondemos el header completo
          header.style.transform = 'translateY(-120%)';
        } else {
          // Scroll hacia arriba: lo mostramos
          header.style.transform = 'translateY(0)';
        }

        lastScroll = currentScroll;
      });
    });
  </script>
</div>
