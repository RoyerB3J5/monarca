---
import { Icon } from 'astro-icon/components';

interface Props {
  /** Texto del botón. Si no se pasa, se renderiza el slot */
  text?: string;
  /** Si se pasa, el componente renderiza un enlace `<a>` en lugar de `<button>` */
  href?: string;
  /** target para el enlace (ej. `_blank`) */
  target?: string;
  /** rel para el enlace; por defecto se aplica `noopener noreferrer` cuando target === '_blank' */
  rel?: string;
  /** Clase base para el botón (layout, paddings, rounded, etc) */
  baseBtnClass?: string;
  /** Clases adicionales que el usuario quiera aplicar (border, bg color, etc) */
  extraBtnClass?: string;
  /** Clase base para el texto */
  baseTextClass?: string;
  iconName?: string;
  /** Clases adicionales para el texto (color, uppercase, size) */
  textClass?: string;
  baseIconClass?: string;
  /** Clases para el icono (sólo color/tamaño si lo deseas) */
  iconClass?: string;
  iconCircleClass?: string;
  iconCircle?: string;
  /** Si se pasa (ms), aplica un 'shake' periódico al botón cada x milisegundos */
  shakeInterval?: number;
  /** Duración del shake en ms */
  shakeDuration?: number;
}

const {
  text = '',
  baseBtnClass = 'flex justify-center items-center py-[5px] rounded-full cursor-pointer gap-2.5 hover:-translate-y-[2px] transition-transform duration-300 ease-in-out z-[10] pl-5 pr-1.5',
  extraBtnClass = '',
  baseTextClass = 'font-medium leading-[120%]  ',
  textClass = 'text-white text-[16px]',
  baseIconClass = 'h-[14px] w-[14px]',
  iconClass = '',
  iconCircle = 'flex p-3 rounded-full  justify-center items-center',
  iconCircleClass = 'bg-white',
  shakeInterval,
  shakeDuration = 700,
  iconName,
  href,
  target,
  rel,
} = Astro.props as Props;

// No id necesario: usamos atributos data- para el script cliente

// Construir clases finales
const buttonClasses = `${baseBtnClass} ${extraBtnClass}`.trim();
const paragraphClasses = `${baseTextClass} ${textClass}`.trim();
const iconClasses = `${baseIconClass} ${iconClass}`.trim();
const iconCircleClasses = `${iconCircle} ${iconCircleClass}`.trim();
---

{
  href ? (
    <a
      href={href}
      class={buttonClasses}
      target={target}
      rel={rel ?? (target === '_blank' ? 'noopener noreferrer' : undefined)}
      data-shake-interval={shakeInterval}
      data-shake-duration={shakeDuration}
    >
      {text ? <p class={paragraphClasses}>{text}</p> : <slot />}
      <div class={iconCircleClasses}>
        <Icon name={iconName} class={iconClasses} />
      </div>
    </a>
  ) : (
    <button
      type="button"
      class={buttonClasses}
      data-shake-interval={shakeInterval}
      data-shake-duration={shakeDuration}
    >
      {text ? <p class={paragraphClasses}>{text}</p> : <slot />}
      <div class={iconCircleClasses}>
        <Icon name={iconName} class={iconClasses} />
      </div>
    </button>
  )
}

{
  /* Shake animation and client script (only rendered when shakeInterval is provided) */
}
{
  shakeInterval ? (
    <>
      <script>
        {`(function(){
          function initShake(){
            try{
              const nodes = document.querySelectorAll('[data-shake-interval]');
              nodes.forEach((el)=>{
                if(el.getAttribute('data-shake-inited')) return;
                const rawInterval = el.getAttribute('data-shake-interval');
                const rawDuration = el.getAttribute('data-shake-duration');
                const intervalMs = parseInt(rawInterval || '0', 10);
                const duration = parseInt(rawDuration || '700', 10);
                if(!intervalMs) {
                  console.debug('[shake] skipping element, invalid interval:', rawInterval, el);
                  return;
                }
                el.setAttribute('data-shake-inited', '1');
                // hint para rendimiento
                try{ el.style.willChange = 'transform'; }catch(e){}
                const keyframes = [
                  { transform: 'translateX(0)' },
                  { transform: 'translateX(-6px)' },
                  { transform: 'translateX(6px)' },
                  { transform: 'translateX(-4px)' },
                  { transform: 'translateX(4px)' },
                  { transform: 'translateX(0)' }
                ];
                const run = ()=>{
                  // don't run if element detached or not visible
                  if(!el.isConnected) return;
                  if(el.offsetParent === null) return; // not visible
                  try{
                    el.animate(keyframes, { duration: duration, easing: 'ease-in-out' });
                  }catch(err){ console.error('[shake] animate failed', err); }
                };
                console.debug('[shake] init', { intervalMs, duration, el });
                // primera ejecución tras un pequeño delay para no golpear al cargar
                setTimeout(()=> run(), 800 + Math.floor(Math.random()*800));
                setInterval(run, intervalMs);
              });
            }catch(e){console.error(e)}
          }
          if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initShake);
          else initShake();
        })()`}
      </script>
    </>
  ) : null
}
