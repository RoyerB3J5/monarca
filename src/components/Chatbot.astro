<!-- Chatbot lazy-load widget: carga bajo demanda para mejorar UX -->
<div class="chatbot-wrapper" aria-hidden="false">
  <button id="chatbot-toggle" aria-label="Abrir chat" class="chatbot-button"
    >ðŸ’¬</button
  >
  <div id="chatbot-loading" class="chatbot-loading" aria-hidden="true" hidden>
    ...
  </div>
</div>

<noscript>
  <a href="/connect/" class="chatbot-noscript">Contacta con nosotros</a>
</noscript>

<style>
  .chatbot-wrapper {
    position: fixed;
    right: 20px;
    bottom: 20px;
    z-index: 9999;
  }
  .chatbot-button {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #0b73ff;
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .chatbot-loading {
    position: fixed;
    right: 86px;
    bottom: 28px;
    background: #fff;
    color: #333;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
  }
  .chatbot-noscript {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: #1e5ebe;
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    text-decoration: none;
  }
</style>

<script>
  (() => {
    const WIDGET_ID = '6941c47ef258cf761dce0e24';
    const RES_URL = 'https://widgets.leadconnectorhq.com/chat-widget/loader.js';
    const SRC = 'https://widgets.leadconnectorhq.com/loader.js';
    let loaded = false;
    const btn = document.getElementById('chatbot-toggle');
    const spinner = document.getElementById('chatbot-loading');
    let idleTimer: any;

    function insertScript() {
      if (loaded) return;
      loaded = true;
      if (spinner) spinner.hidden = false;
      const s = document.createElement('script');
      s.src = SRC;
      s.setAttribute('data-resources-url', RES_URL);
      s.setAttribute('data-widget-id', WIDGET_ID);
      s.async = true;
      s.onload = () => {
        if (spinner) spinner.hidden = true;
      };
      s.onerror = () => {
        if (spinner) spinner.hidden = true;
        console.error('Chat widget failed to load');
      };
      document.body.appendChild(s);
    }

    function onFirstInteraction() {
      clearTimeout(idleTimer);
      insertScript();
      removeInteractionListeners();
    }

    function removeInteractionListeners() {
      window.removeEventListener('pointerdown', onFirstInteraction);
      window.removeEventListener('keydown', onFirstInteraction);
    }

    // Load after a short idle as fallback (adjust ms as desired)
    idleTimer = setTimeout(() => insertScript(), 3000);

    // Load on first user interaction (tap/scroll/keyboard)
    window.addEventListener('pointerdown', onFirstInteraction, { once: true });
    window.addEventListener('keydown', onFirstInteraction, { once: true });

    if (btn) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!loaded) {
          clearTimeout(idleTimer);
          insertScript();
          return;
        }
        // Si el widget ya estÃ¡ cargado, intentamos abrirlo si expone API comÃºn
        try {
          if (window.LC_API && typeof window.LC_API.open_chat === 'function') {
            window.LC_API.open_chat();
          } else if (
            window.LC_API &&
            typeof window.LC_API.toggle === 'function'
          ) {
            window.LC_API.toggle();
          } else if (
            window.leadconnector &&
            typeof window.leadconnector.open === 'function'
          ) {
            window.leadconnector.open();
          }
        } catch (err) {
          /* no-op */
        }
      });
    }
  })();
</script>
